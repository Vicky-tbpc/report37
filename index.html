<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>生理狀態分析報告生成器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root {
            --main-text: #5a5a5a;
            --title-blue: #6c838f;
            --chart-bar: #a0afb7;
            --chart-line: #596b75;
            --range-bg: #f5f1eb;
            --dot-color: #596b75;    
        }
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
        body { font-family: "Microsoft JhengHei", sans-serif; color: var(--main-text); margin: 0; padding: 0; background: #f0f0f0; font-size: 10pt; }
        
        /* 控制面板：手機版自動換行 */
        .controls { background: white; padding: 15px; border-radius: 8px; width: 95%; max-width: 950px; margin: 15px auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .input-row { display: flex; gap: 12px; margin-bottom: 10px; flex-wrap: wrap; }
        .input-item { display: flex; flex-direction: column; flex: 1; min-width: 140px; }
        @media (max-width: 600px) { .input-item { min-width: 100%; } }

        label { font-weight: bold; margin-bottom: 5px; font-size: 9pt; }
        input, textarea, select { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 10pt; }
        textarea { height: 80px; resize: none; }
        
        #report-content { background: #f0f0f0; padding-bottom: 30px; }

        /* 核心調整：預覽時自適應，匯出時強制 A4 */
        .page-container { 
            width: 95%; 
            max-width: 210mm; 
            margin: 15px auto; 
            padding: 10mm; 
            background: white; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative;
        }

        /* 電腦版預覽固定高度 */
        @media (min-width: 850px) {
            .page-container { height: 296mm; page-break-after: always; padding: 12mm 15mm; margin: 0 auto; }
        }
        
        .section { flex: 1; display: flex; flex-direction: column; min-height: 0; border-bottom: 1px solid #f0f0f0; padding: 10px 0; }
        .section:last-child { border-bottom: none; }
        
        .report-header { text-align: center; margin-bottom: 5px; }
        .report-title { color: var(--title-blue); font-size: 18pt; font-weight: bold; margin: 0; }
        .section-header { font-size: 11pt; font-weight: bold; margin: 5px 0; color: var(--main-text); }
        
        /* 資訊網格 */
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 5px; margin-bottom: 8px; }
        
        /* 分析建議佈局 */
        .analysis-layout { display: flex; flex-direction: column; gap: 10px; flex: 1; min-height: 100px; }
        @media (min-width: 600px) {
            .analysis-layout { flex-direction: row; }
            .analysis-img-box { width: 150px; }
        }

        .analysis-text-box { flex: 1; border: 1px solid #eee; padding: 10px; background: #fafafa; line-height: 1.6; font-size: 10pt; white-space: pre-wrap; }
        .analysis-img-box { display: none; aspect-ratio: 1 / 1; border: 1px solid #ddd; overflow: hidden; background: #fff; flex-shrink: 0; }
        .analysis-img-box img { width: 100%; height: 100%; object-fit: cover; }
        
        .chart-container { flex: 1; min-height: 200px; position: relative; width: 100%; margin: 2px 0; }
        .legend-container { display: flex; justify-content: space-between; align-items: center; font-size: 8pt; margin-bottom: 2px; color: #666; flex-wrap: wrap; }
        .legend-items { display: flex; gap: 8px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 4px; }
        
        .icon-dot { width: 8px; height: 8px; background: var(--dot-color); border-radius: 50%; }
        .icon-bar { width: 12px; height: 8px; background: var(--chart-bar); }
        .icon-rect { width: 12px; height: 8px; background: var(--range-bg); border: 1px solid #ddd; }
        
        .status-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px; vertical-align: middle; }
        button { padding: 12px 20px; border: none; cursor: pointer; color: white; border-radius: 4px; font-weight: bold; font-size: 10pt; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }

        .footer-description { margin-top: 10px; font-family: "Microsoft JhengHei", sans-serif; color: var(--main-text); font-size: 8.5pt; line-height: 1.4; }
        .footer-description p { margin: 3px 0; }
        .footer-description strong { color: var(--title-blue); }

        /* PDF 匯出強制格式修正 */
        .pdf-export-mode .page-container {
            width: 210mm !important;
            height: 296mm !important;
            padding: 12mm 15mm !important;
            margin: 0 !important;
            box-shadow: none !important;
            page-break-after: always !important;
        }
        .pdf-export-mode .analysis-layout { flex-direction: row !important; }
        .pdf-export-mode .analysis-img-box { width: 150px !important; display: block !important; }
    </style>
</head>
<body>

<div class="controls">
    <h2>生理狀態分析報告生成器 V43</h2>
    <div class="input-row">
        <div class="input-item"><label>1. 主電量檔案</label><input type="file" id="file1" accept=".xlsx"></div>
        <div class="input-item"><label>2. 自評檔案</label><input type="file" id="file2" accept=".xlsx"></div>
        <div class="input-item"><label>3. 詞句庫檔案</label><input type="file" id="file-lib" accept=".xlsx"></div>
    </div>
    <div class="input-row">
        <div class="input-item"><label>序號</label><input type="text" id="cfg-id" placeholder="例如：BA123456" onchange="autoFetchLib()"></div>
        <div class="input-item"><label>日期 (YYYY/MM/DD)</label><input type="text" id="cfg-date" placeholder="2026/1/1" onchange="autoFetchLib()"></div>
        <div class="input-item">
            <label>詞句抓取版本</label>
            <select id="lib-type" onchange="autoFetchLib()">
                <option value="detailed">詳細解說 (欄位8)</option>
                <option value="simple">易懂健康價值版 (欄位9)</option>
            </select>
        </div>
        <div class="input-item"><label>建議圖片</label><input type="file" id="cfg-img" accept="image/*"></div>
    </div>
    <div class="input-row">
        <div class="input-item">
            <label>當日分析建議:</label>
            <textarea id="in-txt1" placeholder="請輸入或等待自動抓取建議內容..."></textarea>
        </div>
    </div>
    <div class="btn-group">
        <button onclick="generateReport()" style="background:#4CAF50;">生成預覽</button>
        <button onclick="downloadPDF()" style="background:var(--title-blue);">匯出高解析 PDF</button>
    </div>
</div>

<div id="report-content">
    <div class="page-container">
        <div class="report-header"><h1 class="report-title">生理狀態分析</h1></div>
        <div class="section">
            <div class="section-header">當日分析</div>
            <div class="info-grid">
                <div>序號：<span id="out-id"></span></div>
                <div>日期：<span id="out-date"></span></div>
                <div>電量指數：<span id="out-battery"></span></div>
                <div>前7日平均電量：<span id="out-avg7"></span></div>
                <div>生理狀態：<span id="out-status">--</span></div>
            </div>
            <div class="section-header">分析建議</div>
            <div class="analysis-layout">
                <div class="analysis-text-box" id="box-txt1"></div>
                <div class="analysis-img-box" id="img-container"><img id="out-img"></div>
            </div>
            <div class="footer-description">
                <p><strong>電量指數：</strong>透過追蹤您過去7天的脈搏、深睡與自律神經等數據建立個人基準；精確算出每天的「身體電量」，讓您從昨晚的睡眠品質知道今天該衝刺還是休息。</p>
                <p><strong>生理狀態：</strong>透過分析近7～30天的生理數據建立個人基準，利用機器學習即時偵測異常變化，並將複雜的生理資訊轉換為簡單易懂的健康燈號，幫助您快速掌握身體狀態，及早發現可能的發炎跡象並調整生活作息。</p>
            </div>
        </div>
        
        <div class="section">
            <div class="section-header">電量指數14日趨勢</div>
            <div class="legend-container">
                <div></div>
                <div class="legend-items">
                    <div class="legend-item"><div class="icon-dot"></div>當日數值</div>
                    <div class="legend-item"><div class="icon-bar"></div>前7日平均</div>
                </div>
            </div>
            <div class="chart-container"><canvas id="chart-2"></canvas></div>
        </div>

        <div class="section">
            <div class="section-header">N3 深睡比例14日趨勢</div>
            <div class="legend-container">
                <div>單位：%</div>
                <div class="legend-items">
                    <div class="legend-item"><div class="icon-dot"></div>當日數值</div>
                    <div class="legend-item"><div class="icon-bar"></div>前7日平均</div>
                    <div class="legend-item"><div class="icon-rect"></div>標準範圍</div>
                </div>
            </div>
            <div class="chart-container"><canvas id="chart-3"></canvas></div>
        </div>
    </div>

    <div class="page-container">
        <div class="section">
            <div class="section-header">rMSSD 14日趨勢</div>
            <div class="legend-container">
                <div>單位：ms</div>
                <div class="legend-items">
                    <div class="legend-item"><div class="icon-dot"></div>當日數值</div>
                    <div class="legend-item"><div class="icon-bar"></div>前7日平均範圍</div>
                </div>
            </div>
            <div class="chart-container"><canvas id="chart-4"></canvas></div>
        </div>

        <div class="section">
            <div class="section-header">睡眠期間最低脈搏14日趨勢</div>
            <div class="legend-container">
                <div>單位：bpm</div>
                <div class="legend-items">
                    <div class="legend-item"><div class="icon-dot"></div>當日數值</div>
                    <div class="legend-item"><div class="icon-bar"></div>前7日平均範圍</div>
                </div>
            </div>
            <div class="chart-container"><canvas id="chart-5"></canvas></div>
        </div>

        <div class="section">
            <div class="section-header">睡眠期間缺氧負荷指數14日趨勢</div>
            <div class="legend-container">
                <div>單位：%min/h</div>
                <div class="legend-items">
                    <div class="legend-item"><div class="icon-dot"></div>當日數值</div>
                    <div class="legend-item"><div class="icon-bar"></div>前7日平均</div>
                </div>
            </div>
            <div class="chart-container"><canvas id="chart-6"></canvas></div>
        </div>
    </div>
</div>

<script>
    let db1 = null, db2 = null, dbLib = null;
    let charts = {};

    function readExcel(file, callback) {
        const reader = new FileReader();
        reader.onload = (e) => callback(XLSX.read(e.target.result, { type: 'binary' }));
        reader.readAsBinaryString(file);
    }

    document.getElementById('file1').onchange = (e) => readExcel(e.target.files[0], d => { db1 = d; autoFetchLib(); });
    document.getElementById('file2').onchange = (e) => readExcel(e.target.files[0], d => db2 = d);
    document.getElementById('file-lib').onchange = (e) => readExcel(e.target.files[0], d => { dbLib = d; autoFetchLib(); });

    function getSymbol(todayVal, yestVal, type) {
        if (type === 'HBI') return todayVal === yestVal ? '＝' : (todayVal > yestVal ? '▲' : '▼');
        if (type === 'Battery' || type === 'N3') return todayVal > yestVal ? '▲' : (todayVal < yestVal ? '▼' : '＝');
        return todayVal < yestVal ? '▼' : (todayVal > yestVal ? '▲' : '＝');
    }

    function getMA(full, currIdx, col, days) {
        const slice = full.slice(Math.max(0, currIdx - days), currIdx);
        if(!slice.length) return null;
        const validData = slice.map(r => Number(r[col])).filter(val => !isNaN(val));
        if(!validData.length) return null;
        return Math.round(validData.reduce((a, b) => a + b, 0) / validData.length);
    }

    function autoFetchLib() {
        const sid = document.getElementById('cfg-id').value.trim();
        const tDate = document.getElementById('cfg-date').value.trim();
        if (!db1 || !dbLib || !sid || !tDate) return;
        const data1 = XLSX.utils.sheet_to_json(db1.Sheets[sid]);
        const searchDate = tDate.trim().replace(/\//g, '-');
        const idx = data1.findIndex(r => String(r.record_end).includes(searchDate) || String(r.record_end).includes(tDate));
        if (idx > 0) {
            const today = data1[idx], yest = data1[idx-1];
            const pattern = `${getSymbol(today.Battery_TST_min_A, yest.Battery_TST_min_A, 'Battery')},${getSymbol(today.N3_pct, yest.N3_pct, 'N3')},${getSymbol(today.rMSSD, yest.rMSSD, 'rMSSD')},${getSymbol(today.HR_min, yest.HR_min, 'HR')},${getSymbol(today.HBI, yest.HBI, 'HBI')},X,X`;
            const libSheet = dbLib.Sheets['battery'] || dbLib.Sheets[Object.keys(dbLib.Sheets)[0]];
            const libData = XLSX.utils.sheet_to_json(libSheet, { header: 1 });
            const match = libData.find(r => r.slice(0, 7).join(',') === pattern);
            if (match) {
                const libType = document.getElementById('lib-type').value;
                document.getElementById('in-txt1').value = match[(libType === 'detailed') ? 7 : 8] || "";
            }
        }
    }

    function generateReport() {
        const sid = document.getElementById('cfg-id').value.trim();
        const tDate = document.getElementById('cfg-date').value.trim();
        if(!db1 || !db2) return alert("請上傳檔案");
        const s1 = db1.Sheets[sid], s2 = db2.Sheets[sid];
        const data1 = XLSX.utils.sheet_to_json(s1);
        const data2 = XLSX.utils.sheet_to_json(s2);
        const searchDate = tDate.trim().replace(/\//g, '-');
        const idx = data1.findIndex(r => String(r.record_end).includes(searchDate) || String(r.record_end).includes(tDate));
        if(idx === -1) return alert("日期錯誤");

        document.getElementById('out-id').innerText = sid;
        document.getElementById('out-date').innerText = tDate;
        document.getElementById('out-battery').innerText = data1[idx].Personal_Battery_weighted_round || 0;
        document.getElementById('out-avg7').innerText = getMA(data1, idx, 'Personal_Battery_weighted_round', 7) || '--';
        document.getElementById('box-txt1').innerText = document.getElementById('in-txt1').value;

        const sRow = data2.find(r => r.日期 && String(r.日期).replace(/\//g, '-').includes(searchDate));
        const statusVal = (sRow && sRow.生理狀態燈號) ? sRow.生理狀態燈號 : '--';
        if (statusVal !== '--') {
            const cMap = { '紅燈': '#ff0000', '黃紅燈': '#ff8000', '黃燈': '#ffe632', '綠燈': '#3caa28' };
            document.getElementById('out-status').innerHTML = `<span class="status-dot" style="background:${cMap[statusVal] || '#ccc'}"></span>${statusVal}`;
        }

        const imgFile = document.getElementById('cfg-img').files[0];
        if(imgFile) {
            document.getElementById('out-img').src = URL.createObjectURL(imgFile);
            document.getElementById('img-container').style.display = 'block';
        }

        const d14 = data1.slice(Math.max(0, idx - 13), idx + 1);
        const labels = d14.map(r => String(r.record_end).split(' ')[0].substring(5).replace('-', '/'));
        const offset = data1.indexOf(d14[0]);

        draw('chart-2', labels, d14.map(r=>r.Personal_Battery_weighted_round), d14.map((_, i)=>getMA(data1, offset+i, 'Personal_Battery_weighted_round', 7)), 'bar');
        draw('chart-3', labels, d14.map(r=>r.N3_pct), d14.map((_, i)=>getMA(data1, offset+i, 'N3_pct', 7)), 'bar', { range: [10, 20] });
        draw('chart-4', labels, d14.map(r=>r.rMSSD), d14.map((_, i)=>{
            let a = getMA(data1, offset+i, 'rMSSD', 7); return a ? [a*0.9, a*1.1] : null;
        }), 'range');
        draw('chart-5', labels, d14.map(r=>r.HR_min), d14.map((_, i)=>{
            let a = getMA(data1, offset+i, 'HR_min', 7); return a ? [a-5, a+5] : null;
        }), 'range');
        draw('chart-6', labels, d14.map(r=>r.HBI), d14.map((_, i)=>getMA(data1, offset+i, 'HBI', 7)), 'bar');
    }

    function draw(id, labels, lineData, helperData, type, extra={}) {
        if(charts[id]) charts[id].destroy();
        charts[id] = new Chart(document.getElementById(id), {
            data: {
                labels,
                datasets: [
                    { type: 'line', data: lineData, borderColor: '#596b75', backgroundColor: '#596b75', borderWidth: 2, pointRadius: 3, z: 10 },
                    { type: 'bar', data: helperData, backgroundColor: '#a0afb7', barPercentage: 0.5, categoryPercentage: 0.8 }
                ]
            },
            plugins: extra.range ? [{
                beforeDraw: (c) => {
                    const {ctx, chartArea, scales: {y}} = c;
                    ctx.save(); ctx.beginPath(); ctx.rect(chartArea.left, chartArea.top, chartArea.width, chartArea.height); ctx.clip();
                    ctx.fillStyle = '#f5f1eb';
                    const top = y.getPixelForValue(extra.range[1]), bottom = y.getPixelForValue(extra.range[0]);
                    ctx.fillRect(chartArea.left, top, chartArea.width, bottom - top); ctx.restore();
                }
            }] : [],
            options: {
                devicePixelRatio: 4, maintainAspectRatio: false,
                scales: { y: { ticks: { font: { size: 8 } } }, x: { grid: { display: false }, ticks: { font: { size: 8 } } } },
                plugins: { legend: { display: false } }
            }
        });
    }

    function downloadPDF() {
        const element = document.getElementById('report-content');
        const sid = document.getElementById('cfg-id').value.trim() || "Report";
        const rawDate = document.getElementById('cfg-date').value.trim();
        let dateStr = rawDate.replace(/[\/\-]/g, '');

        // 重要：在手機上匯出前，強制進入 PDF 渲染模式（鎖定電腦版佈局）
        document.body.classList.add('pdf-export-mode');

        const opt = {
            margin: 0,
            filename: `生理狀態分析_${sid}_${dateStr}.pdf`,
            image: { type: 'jpeg', quality: 1.0 },
            html2canvas: { 
                scale: 4, 
                useCORS: true, 
                logging: false,
                windowWidth: 1200 // 強制以電腦版視窗寬度渲染
            },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(element).toPdf().get('pdf').save().then(() => {
            // 匯出完成後移除 PDF 渲染模式，恢復網頁預覽
            document.body.classList.remove('pdf-export-mode');
        });
    }
</script>
</body>
</html>
